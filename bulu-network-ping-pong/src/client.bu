// Bulu TCP Client - Ping-Pong Example
// Make sure server.bu is running first!

import { TcpConnection, NetAddr } from "std/net"
import { sleep } from "std/time"

func main() {
    println("=== BULU TCP CLIENT ===")
    println("")
    
    let port = 9090
    let addr = NetAddr.localhost_ipv4(port)
    
    println("ğŸ”— Connecting to TCP server at localhost:" + port.toString() + "...")
    
    let conn = TcpConnection.connect(addr)
    if conn.isError() {
        println("âŒ Failed to connect to server: " + conn.error().toString())
        println("ğŸ’¡ Make sure the server is running first!")
        return
    }
    
    let conn_unwrapped = conn.unwrap()
    println("âœ… Connected to server at " + addr.toString())
    println("")
    
    // Ping-pong loop
    for i in 0..10 {
        // Send ping
        let pingMessage = "PING " + i.toString()
        let bytesWritten = conn_unwrapped.write(pingMessage.bytes())
        if bytesWritten.isError() {
            println("âŒ Error writing to server: " + bytesWritten.error().toString())
            break
        }
        
        println("ğŸ“¤ Client sent: " + pingMessage)
        
        // Read pong response
        let buffer = make([]byte, 1024)
        let bytesRead = conn_unwrapped.read(buffer)
        if bytesRead.isError() {
            println("âŒ Error reading from server: " + bytesRead.error().toString())
            break
        }
        
        let bytesRead_unwrapped = bytesRead.unwrap()
        if bytesRead_unwrapped == 0 {
            println("ğŸ”Œ Server disconnected")
            break
        }
        
        let message = string(buffer[0:bytesRead_unwrapped])
        println("ğŸ“¨ Client received: " + message)
        println("")
        
        // Small delay between messages
        sleep(200) // 200ms
    }
    
    conn_unwrapped.close()
    println("âœ… Client finished - connection closed")
}
