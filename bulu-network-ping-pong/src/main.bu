// Bulu Network Ping-Pong Example
// Tests TCP and UDP networking functionality

import { TcpServer, TcpConnection, UdpConnection, NetAddr } from "std/net"
import { sleep } from "std/time"

func main() {
    println("=== BULU NETWORK PING-PONG DEMO ===")
    println("")
    
    // Test TCP Ping-Pong
    println("ğŸ”— Testing TCP Ping-Pong...")
    testTcpPingPong()
    
    // Wait for goroutines to finish
    // In a real app, you'd use channels or WaitGroup
    println("")
    println("â³ Waiting for goroutines to finish...")
    sleep(2000) // 2 seconds should be enough
    
    println("")
    
    // Test UDP Ping-Pong  
    println("ğŸ“¡ Testing UDP Ping-Pong...")
    testUdpPingPong()
    
    println("")
    println("âœ… All network tests completed!")
}

func testTcpPingPong() {
    let port = 9080
    let addr = NetAddr.localhost_ipv4(port)
    
    println("Starting TCP server on localhost:" + port.toString())
    
    // Start TCP server in a goroutine
    run runTcpServer(addr)
    
    // Give server time to start
    sleep(100) // 100ms
    
    // Connect as client and send ping-pong messages in a goroutine
    run runTcpClient(addr)
}

func runTcpServer(addr: NetAddr) {
    let server = TcpServer.bind(addr)
    if server.isError() {
        println("âŒ Failed to bind TCP server: " + server.error().toString())
        return
    }
    
    println("âœ… TCP Server listening on " + addr.toString())
    
    // Accept one connection for demo
    let server_unwrapped = server.unwrap()
    let conn = server_unwrapped.accept()
    if conn.isError() {
        println("âŒ Failed to accept connection: " + conn.error().toString())
        return
    }
    
    let conn_unwrapped = conn.unwrap()
    println("ğŸ“ Client connected")
    
    // Ping-pong loop
    for i in 0..5 {
        // Read ping from client
        let buffer = make([]byte, 1024)
        let bytesRead = conn_unwrapped.read(buffer)
        if bytesRead.isError() {
            println("âŒ Error reading from client: " + bytesRead.error().toString())
            break
        }
        
        let bytesRead_unwrapped = bytesRead.unwrap()
        let message = string(buffer[0:bytesRead_unwrapped])
        println("ğŸ“¨ Server received: " + message)
        
        // Send pong back
        let pongMessage = "PONG " + i.toString()
        let bytesWritten = conn_unwrapped.write(pongMessage.bytes())
        if bytesWritten.isError() {
            println("âŒ Error writing to client: " + bytesWritten.error().toString())
            break
        }
        
        println("ğŸ“¤ Server sent: " + pongMessage)
    }
    
    conn_unwrapped.close()
    println("ğŸ”Œ TCP Server connection closed")
}

func runTcpClient(addr: NetAddr) {
    println("ğŸ”— Connecting to TCP server...")
    
    let conn = TcpConnection.connect(addr)
    if conn.isError() {
        println("âŒ Failed to connect to server: " + conn.error().toString())
        return
    }
    
    let conn_unwrapped = conn.unwrap()
    println("âœ… Connected to server at " + addr.toString())
    
    // Ping-pong loop
    for i in 0..5 {
        // Send ping
        let pingMessage = "PING " + i.toString()
        let bytesWritten = conn_unwrapped.write(pingMessage.bytes())
        if bytesWritten.isError() {
            println("âŒ Error writing to server: " + bytesWritten.error().toString())
            break
        }
        
        println("ğŸ“¤ Client sent: " + pingMessage)
        
        // Read pong response
        let buffer = make([]byte, 1024)
        let bytesRead = conn_unwrapped.read(buffer)
        if bytesRead.isError() {
            println("âŒ Error reading from server: " + bytesRead.error().toString())
            break
        }
        
        let bytesRead_unwrapped = bytesRead.unwrap()
        let message = string(buffer[0:bytesRead_unwrapped])
        println("ğŸ“¨ Client received: " + message)
        
        // Small delay between messages
        sleep(50) // 50ms
    }
    
    conn_unwrapped.close()
    println("ğŸ”Œ TCP Client connection closed")
}

func testUdpPingPong() {
    let serverPort = 8081
    let clientPort = 8082
    let serverAddr = NetAddr.localhost_ipv4(serverPort)
    let clientAddr = NetAddr.localhost_ipv4(clientPort)
    
    println("Starting UDP ping-pong between ports " + serverPort.toString() + " and " + clientPort.toString())
    
    // Start UDP server in a goroutine
    run runUdpServer(serverAddr, clientAddr)
    
    // Give server time to start
    sleep(100) // 100ms
    
    // Run UDP client in a goroutine
    run runUdpClient(clientAddr, serverAddr)
    
    // Wait for UDP goroutines to finish
    sleep(2000) // 2 seconds
}

func runUdpServer(serverAddr: NetAddr, clientAddr: NetAddr) {
    let socket = UdpConnection.bind(serverAddr)
    if socket.isError() {
        println("âŒ Failed to bind UDP server: " + socket.error().toString())
        return
    }
    
    let socket_unwrapped = socket.unwrap()
    println("âœ… UDP Server listening on " + serverAddr.toString())
    
    // Ping-pong loop
    for i in 0..5 {
        // Read ping from client
        let buffer = make([]byte, 1024)
        let result = socket_unwrapped.recv_from(buffer)
        if result.isError() {
            println("âŒ Error reading UDP message: " + result.error().toString())
            break
        }
        let result_unwrapped = result.unwrap()
        let (bytesRead, fromAddr) = result_unwrapped;
        let message = string(buffer[0:bytesRead]);
        println("ğŸ“¨ UDP Server received from " + fromAddr.toString() + ": " + message);
        
        // Send pong back
        let pongMessage = "UDP_PONG " + i.toString()
        let bytesSent = socket_unwrapped.send_to(pongMessage.bytes(), clientAddr)
        if bytesSent.isError() {
            println("âŒ Error sending UDP message: " + bytesSent.error().toString())
            break
        }
        
        println("ğŸ“¤ UDP Server sent: " + pongMessage)
    }
    
    println("ğŸ”Œ UDP Server finished")
}

func runUdpClient(clientAddr: NetAddr, serverAddr: NetAddr) {
    let socket = UdpConnection.bind(clientAddr)
    if socket.isError() {
        println("âŒ Failed to bind UDP client: " + socket.error().toString())
        return
    }
    
    let socket_unwrapped = socket.unwrap()
    println("âœ… UDP Client bound to " + clientAddr.toString())
    
    // Ping-pong loop
    for i in 0..5 {
        // Send ping
        let pingMessage = "UDP_PING " + i.toString()
        let bytesSent = socket_unwrapped.send_to(pingMessage.bytes(), serverAddr)
        if bytesSent.isError() {
            println("âŒ Error sending UDP message: " + bytesSent.error().toString())
            break
        }
        
        println("ğŸ“¤ UDP Client sent: " + pingMessage)
        
        // Read pong response
        let buffer = make([]byte, 1024)
        let result = socket_unwrapped.recv_from(buffer)
        if result.isError() {
            println("âŒ Error reading UDP response: " + result.error().toString())
            break
        }
        
        let result_unwrapped = result.unwrap()
        let (bytesRead, fromAddr) = result_unwrapped
        let message = string(buffer[0:bytesRead])
        println("ğŸ“¨ UDP Client received from " + fromAddr.toString() + ": " + message)
        
        // Small delay between messages
        sleep(50) // 50ms
    }
    
    println("ğŸ”Œ UDP Client finished")
}