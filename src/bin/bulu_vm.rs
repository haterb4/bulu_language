//! Bulu Bytecode Interpreter
//!
//! This executable can run Bulu bytecode files generated by the langc compiler.

use bulu::runtime::Interpreter;
use bulu::{BuluError, Result};
use clap::{Arg, Command};
use colored::*;
use std::path::PathBuf;
use std::process;

fn main() -> Result<()> {
    let matches = Command::new("bulu")
        .version(bulu::VERSION)
        .about("Bulu Bytecode Interpreter")
        .long_about("Bulu Bytecode Interpreter executes compiled Bulu bytecode files.")
        .arg(
            Arg::new("input")
                .help("Input bytecode file")
                .required(true)
                .index(1)
                .value_parser(clap::value_parser!(PathBuf))
        )
        .arg(
            Arg::new("verbose")
                .short('v')
                .long("verbose")
                .help("Enable verbose output")
                .action(clap::ArgAction::SetTrue)
        )
        .get_matches();

    let input_file = matches.get_one::<PathBuf>("input").unwrap();
    let verbose = matches.get_flag("verbose");

    if verbose {
        println!("{}", "Bulu Bytecode Interpreter".bright_blue().bold());
        println!("Version: {}", bulu::VERSION);
        println!("Input: {}", input_file.display());
        println!();
    }

    // Validate input file
    if !input_file.exists() {
        eprintln!("{}: Input file '{}' not found", "error".bright_red().bold(), input_file.display());
        process::exit(1);
    }

    // Create interpreter and load bytecode
    let mut interpreter = Interpreter::new();
    
    if verbose {
        println!("{}", "Loading bytecode...".bright_yellow());
    }
    
    match interpreter.load_bytecode(input_file) {
        Ok(_) => {
            if verbose {
                println!("{}", "Bytecode loaded successfully".bright_green());
                println!("{}", "Executing program...".bright_yellow());
                println!();
            }
        }
        Err(e) => {
            eprintln!("{}: Failed to load bytecode: {}", "error".bright_red().bold(), e);
            process::exit(1);
        }
    }

    // Execute the program
    match interpreter.execute() {
        Ok(result) => {
            if verbose {
                println!();
                println!("{}", "Program executed successfully".bright_green().bold());
                println!("Result: {}", result.to_string());
            }
            Ok(())
        }
        Err(e) => {
            eprintln!("{}: Runtime error: {}", "error".bright_red().bold(), e);
            process::exit(1);
        }
    }
}